#!/bin/bash
# Update package lists
sudo apt update

# Configure hostname (replace [STUDENT_ID] with your actual ID)
HOSTNAME="$428422-lb-01"
sudo hostnamectl set-hostname "$HOSTNAME"

# Install HAproxy
sudo apt install haproxy

# Backup default configuration file
sudo cp /etc/haproxy/haproxy.cfg /etc/haproxy/haproxy.cfg.bak

# Configure HAproxy

# Replace 'your_strong_password' with a strong password
cat << EOF > /etc/haproxy/haproxy.cfg
global
    log /dev/log local0 info
    maxconn 4000
    user haproxy
    group haproxy
    stats timeout 2m
    stats socket /var/lib/haproxy/stats.sock
    stats realm HAProxy Statistics
    stats auth your_strong_password

defaults
    mode http
    option httplog
    balance roundrobin
    option httpcheck

frontend http-in
    bind *:80
    default_backend webservers

backend webservers
    option httpchk
    http-check uri /healthcheck path / OK
    balance roundrobin
    server web-01 428422-web-01:80 weight 1 maxconn 200
    server web-02 428422-web-02:80 weight 1 maxconn 200
EOF

# Enable and start HAproxy service
sudo systemctl enable haproxy
sudo systemctl start haproxy

# Verify service status
sudo systemctl status haproxy
