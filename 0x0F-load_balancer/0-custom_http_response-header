#!/usr/bin/env bash

# Update Nginx package lists
sudo apt-get update

# Check if Nginx is already installed
if [[ $(dpkg-query -l nginx | grep installed) ]]; then
  echo "Nginx is already installed."
else
  # Install Nginx if not present
  echo "Installing Nginx..."
  sudo apt-get install -y nginx || {
    echo "Error installing Nginx. Please check package repositories and try again."
    exit 1
  }
fi

# Add custom response header (X-Served-By)
escaped_hostname=$(hostname | sed 's/[^\w\-_]//g')
sudo sed -i "/server_name _/a add_header X-Served-By \$hostname;" /etc/nginx/sites-available/default

# Create a symbolic link from sites-available to sites-enabled
sudo ln -s /etc/nginx/sites-available/default /etc/nginx/sites-enabled/

# Test Nginx configuration for errors
sudo nginx -t || {
  echo "Error in Nginx configuration. Please check the logs (/etc/nginx/error.log) and make corrections."
  exit 1
}

# Reload Nginx
sudo service nginx reload

echo "Nginx configuration complete!"
