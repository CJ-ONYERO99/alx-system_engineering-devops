#!/usr/bin/env bash

# Update package lists
apt-get update

# Install nginx
apt-get install -y nginx

# Create a new user for Nginx processes
useradd -r -s /sbin/nologin nginx

# Create a directory for the website (owned by nginx user)
mkdir -p /var/www/html && chown nginx:nginx /var/www/html

# Create a backup directory for the default index
mkdir -p /etc/nginx/backups

# Create a new file for the default website (owned by nginx user)
echo "server {
  listen 80;
  server_name localhost;

  # Document root for the website (owned by nginx user)
  root /var/www/html;

  # Return a simple "Hello World!" message
  location / {
    try_files \$uri /index.html;
    index index.html index.htm;
    add_header Content-Type text/html;
    echo "Hello World!";
  }
}" > /etc/nginx/sites-available/default && chown nginx:nginx /etc/nginx/sites-available/default

# Enable the default website configuration
ln -s /etc/nginx/sites-available/default /etc/nginx/sites-enabled/default

# Backup the default index configuration before modification
cp /etc/nginx/sites-available/default /etc/nginx/backups/default.$(date +%Y-%m-%d)

# Reload nginx configuration without systemctl
service nginx reload

# Test if "Hello World!" is returned
if [ "$(curl -s localhost)" == "Hello World!" ]; then
  echo "Nginx is installed and configured successfully!"
else
  echo "Error: Nginx configuration might be incorrect."
fi
